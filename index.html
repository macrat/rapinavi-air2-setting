<!DOCTYPE html>

<html>
<head>
<title>rapiNAVI Air2 設定支援アプリ</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<style>
body {
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	align-items: flex-start;
	align-content: flex-start;
}
div {
	border: 2px solid gray;
	margin: 1em;
	padding: 1em;
	min-width: 45em;
}
h2 {
	margin: 0;
	padding: .1em 0 .5em;
	text-align: center;
	border-bottom: 1px solid gray;
	font-size: 150%;
}

input {
	border: 2px solid gray;
	padding: .1em .3em;
	margin: 0;
}
input:invalid {
	border: 2px solid orange;
}
.message:not(:empty) {
	background-color: orange;
	margin: 0;
	padding: .1em .3em;
}

footer {
	position: fixed;
	bottom: 0;
	right: 0;
	color: gray;
	font-size: 80%;
}

@media screen and (max-width: 50em) {
	body {
		display: block;
		margin: 0;
	}
	div {
		min-width: auto;
		margin: 0;
		border: 0;
	}
	footer {
		position: relative;
		top: 0;
		left: 0;
		padding: .5em;
		padding: .5em;
		text-align: right;
	}
}
</style>
</head>

<body>
<div>
	<h2>設定したい値</h2>
	<p><label id=url>URL: <input type=url size=29 maxlength=28 required><span class=message>入力してください。</span></label></p>
	<p><label id=power>電波強度: <select>
		<option value=0>+4dBm</option>
		<option value=1>0dBm</option>
		<option value=2>-4dBm</option>
		<option value=3>-8dBm</option>
		<option value=4>-12dBm</option>
		<option value=5>-16dBm</option>
		<option value=6>-20dBm</option>
		<option value=7>-30dBm</option>
		<option value=8>-40dBm</option>
	</select></label></p>
	<p><label id=frequency>配信頻度: <input type=range min=100 max=1000 step=100 value=500> <span>500ms</span></label></p>
</div>

<div>
	<h2>設定アプリ上での値</h2>
	<p><label id=uuid>UUID: <input size=33 maxlength=32><span class=message>入力してください。</span></label></p>
	<p><label id=major>major: <input size=5 maxlength=4 value=1000 required><span class=message></label></span></p>
	<p><label id=power_out>Tx Power: <input size=3 maxlength=2 min=0 max=8 value=00 required><span class=message></span></label></p>
	<p><label id=freq_out>Advertising Interval: <input size=5 maxlength=4 value=01F4><span class=message></label></p>
</div>

<footer>MIT License (c)2016 MacRat</footer>

<script>
const url_input = document.querySelector('#url input');
const url_msg = document.querySelector('#url .message');
const power_input = document.querySelector('#power select');
const frequency_input = document.querySelector('#frequency input');
const frequency_value = document.querySelector('#frequency span');

const uuid_input = document.querySelector('#uuid input');
const uuid_msg = document.querySelector('#uuid .message');
const major_input = document.querySelector('#major input');
const major_msg = document.querySelector('#major .message');
const power_out_input = document.querySelector('#power_out input');
const power_out_msg = document.querySelector('#power_out .message');
const frequency_out_input = document.querySelector('#freq_out input');
const frequency_out_msg = document.querySelector('#freq_out .message');

const scheme = [
	'http://www.',
	'https://www.',
	'http://',
	'https://',
];
const major_list = [
	'1004',
	'1000',
	'10FC',
	'10F8',
	'10F4',
	'10F0',
	'10EC',
	'10E2',
	'10D8',
];

function id_to_scheme(id) {
	if(id < 0 || scheme.length <= id){
		throw new Error('不正なschemeです。');
	}
	return scheme[parseInt(id)];
}

function split_url(u) {
	for(let i=0; i<scheme.length; i++){
		if(u.indexOf(scheme[i]) == 0){
			const suburl = u.substr(scheme[i].length, u.length);
			if(suburl.length == 0){
				throw new Error('短かぎます。');
			}
			if(suburl.length > 15){
				throw new Error('長すぎます。');
			}
			return [i, suburl];
		}
	}
	throw new Error('http://かhttps://で始まるものでなければなりません。');
}

function power_to_major(p) {
	if(p < 0 || 8 < p){
		throw new Error('不正なTxPowerです。');
	}
	return major_list[parseInt(p)];
}

function major_to_power(m) {
	let p = major_list.indexOf(m);

	if(p < 0){
		throw new Error('不正なmajorです。');
	}
	return p;
}

function string_to_hex(str) {
	return str.split('').map(x => x.charCodeAt(0).toString(16).toUpperCase()).join('');
}

function hex_to_string(str) {
	let result = '';
	for(let i=0; i<str.length; i+=2){
		let x = parseInt(str.slice(i, i+2), 16);
		if(x == 0){
			if(parseInt(str.slice(i), 16) != 0){
				throw new Error('不正な文字列です。');
			}
			break;
		}
		result += String.fromCharCode(x);
	}
	return result;
}

function make_url_hex(scheme_id, url_) {
	const result = '0' + scheme_id + string_to_hex(url_);
	return result + '0'.repeat(32 - result.length)
}

function url_to_uuid(u) {
	if(u.length == 0){
		throw new Error('入力してください。');
	}else{
		let x = split_url(u);
		return make_url_hex(x[0], x[1]);
	}
}

function url_validation() {
	url_input.setCustomValidity('');
	try{
		url_to_uuid(url_input.value);
	}catch(e){
		url_input.setCustomValidity(e.message);
	}
	url_msg.innerText = url_input.validationMessage;
}

url_input.addEventListener('keyup', e => {
	url_input.setCustomValidity('');
	uuid_input.value = '';
	try{
		uuid_input.value = url_to_uuid(url_input.value);
	}catch(e){
		url_input.setCustomValidity(e.message);
	}
	url_msg.innerText = url_input.validationMessage;
	uuid_validation();
});

power_input.addEventListener('change', e => {
	if(power_input.value.length != 2){
		power_out_input.value = '0' + power_input.value;
	}
	major_input.value = power_to_major(power_input.value);
});

frequency_input.addEventListener('input', e => {
	frequency_value.innerText = frequency_input.value + 'ms';
	frequency_out_input.value = ('0'.repeat(4) + parseInt(frequency_input.value).toString(16).toUpperCase()).slice(-4);
});

function uuid_validation() {
	uuid_input.setCustomValidity('');
	if(uuid_input.value.length != 32){
		uuid_input.setCustomValidity('UUIDは32文字でなればなりません。');
	}else{
		try{
			id_to_scheme(parseInt(uuid_input.value.slice(0, 2), 16));
		}catch(e){
			uuid_input.setCustomValidity('Eddystone-URLのUUIDではありません。');
		}
	}
	uuid_msg.innerText = uuid_input.validationMessage;
}

uuid_input.setCustomValidity('入力してください。');
uuid_input.onkeydown = e => e.key.length > 1 || '0123456789abcdefABCDEF'.indexOf(e.key) >= 0;
uuid_input.addEventListener('keyup', e => {
	uuid_input.setCustomValidity('');
	url_input.value = '';
	let upper = uuid_input.value.toUpperCase();
	if(uuid_input.value != upper){
		uuid_input.value = upper;
	}
	if(uuid_input.value.length == 0){
		uuid_input.setCustomValidity('入力してください。');
	}else if(uuid_input.value.length != 32){
		uuid_input.setCustomValidity('32文字でなればなりません。');
	}else{
		try{
			let scheme = id_to_scheme(parseInt(uuid_input.value.slice(0, 2), 16));
			url_input.value = scheme + hex_to_string(uuid_input.value.slice(2));
		}catch(e){
			uuid_input.setCustomValidity('Eddystone-URLのUUIDではありません。');
		}
	}
	url_validation();
	uuid_msg.innerText = uuid_input.validationMessage;
});

function major_changed() {
	if(major_input.value.length == 0){
		major_input.setCustomValidity('入力してください。');
	}else{
		let upper = major_input.value.toUpperCase();
		if(major_input.value != upper){
			major_input.value = upper;
		}
		try{
			power_input.value = major_to_power(major_input.value);
			power_out_input.value = '0' + power_input.value;
			major_input.setCustomValidity('');
		}catch(e){
			major_input.setCustomValidity('不正な値です。');
		}
	}
	major_msg.innerText = major_input.validationMessage;
}
major_input.addEventListener('change', e => major_changed());
major_input.addEventListener('keyup', e => major_changed());

function power_out_changed() {
	if(power_out_input.value.length == 0){
		power_out_input.setCustomValidity('入力してください。');
	}else if(parseInt(power_out_input.value) < 0 || 8 < parseInt(power_out_input.value)){
		power_out_input.setCustomValidity('0から8の間でなればなりません。');
	}else{
		power_input.value = parseInt(power_out_input.value);
		major_input.value = power_to_major(power_input.value);
		power_out_input.setCustomValidity('');
	}
	power_out_msg.innerText = power_out_input.validationMessage;
}
frequency_out_input.onkeydown = e => e.key.length > 1 || '0123456789'.indexOf(e.key) >= 0;
power_out_input.addEventListener('change', e => power_out_changed());
power_out_input.addEventListener('keyup', e => power_out_changed());

frequency_out_input.onkeydown = e => e.key.length > 1 || '0123456789abcdefABCDEF'.indexOf(e.key) >= 0;
frequency_out_input.addEventListener('keyup', e => {
	frequency_out_input.setCustomValidity('');
	let upper = frequency_out_input.value.toUpperCase();
	if(frequency_out_input.value != upper){
		frequency_out_input.value = upper;
	}
	if(frequency_out_input.value.length == 0){
		frequency_out_input.setCustomValidity('入力してください。');
	}else if(frequency_out_input.value.length != 4){
		frequency_out_input.setCustomValidity('4文字でなればなりません。');
	}else{
		let val = parseInt(frequency_out_input.value, 16);
		if(val < 100 || 1000 < val){
			frequency_out_input.setCustomValidity('0064から03E8の間でなればなりません。');
		}else if(val%100 != 0){
			frequency_out_input.setCustomValidity('10進数で100の倍数でなればなりません。');
		}else{
			frequency_input.value = parseInt(frequency_out_input.value, 16)
			frequency_value.innerText = frequency_input.value + 'ms';
		}
	}
	frequency_out_msg.innerText = frequency_out_input.validationMessage;
});
</script>
</body>
</html>
